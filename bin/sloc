#!/usr/bin/env fish

if test "$argv" = "--help"
  echo "sloc"
  echo "sloc <COLUMN...>"
  echo "sloc COLUMN <COLUMN|TOTAL...>"
  echo "COLUMN is one of (dir, ext, name, path, author, lines)"
  exit 0
end

git ls-files | gawk "!/.pdf\$/ && !/.lock\$/ && !/.mdx\$/" | xargs -n1 git --no-pager blame --show-name -- | gawk "
BEGIN {
  split(\"$argv\", argv, \" \")
  header = \"\"
  col_count = 0
  for (i in argv) {
    # skip total: it's not a column
    if (argv[i] == \"total\") continue

    col_count = col_count + 1
    name = toupper(argv[i])
    cols[col_count] = name
    header = header name \"\\t\"
  }
  if (header !~ /LINES/) {
    header = header \"LINES\" \"\\t\"
    col_count += 1
    cols[col_count] = \"LINES\"
  }
  print header
}

{
  path = \$2
  
  name = substr(\$3, 2)
  if (name == \"Not\") name = \"uncommitted\"

  split(path, parts, \"/\")
  dir = \"root\"
  if (length(parts) > 1)            dir = parts[1] 
  if (substr(dir, 1, 1) == \".\")   dir = \"root\"

  split(path, parts, \".\")
  ext = parts[length(parts)]
  if (length(parts) == 1)   ext = \"none\"
  if (dir == \"bin\")       ext = \"bash\"
  if (dir == \"root\")      ext = \"config\"
  if (ext ~ \"/\")          ext = \"none\"

  key = \"\"
  total = \"\"
  part_count = 0
  for (i in argv) {
    arg = argv[i]
    if (arg == \"total\") {
      part_index = part_count + 1
      if (part_index > col_count || part_index == 1) {
        print \"ERROR: total can't be first or last column\"
        exit 1
      }


      total_key = key
      for (; part_index <= col_count; part_index++) {
        col = cols[part_index]
        if (col == \"LINES\") { total_key = total_key \"LINES\" \"\\t\" }
        else                  { total_key = total_key \"*\"     \"\\t\" }
      }
      stats[total_key] += 1
      continue
    }
    part_count = part_count + 1
    if (arg == \"dir\")      { key = key   dir         \"\\t\" }
    if (arg == \"ext\")      { key = key   ext         \"\\t\" }
    if (arg == \"author\")   { key = key   name        \"\\t\" }
    if (arg == \"path\")     { key = key   path        \"\\t\" }
    if (arg == \"lines\")    { key = key   \"LINES\"   \"\\t\" }
  }
  if (key !~ /LINES/)        { key = key   \"LINES\"   \"\\t\" }

  stats[key] += 1
}

function compare_parts(_1, a, _2, b) {
  split(a, a_parts, \"\\t\")
  split(b, b_parts, \"\\t\")

  if (length(a_parts) != length(b_parts)) {
    return -1
  }

  for (i in a_parts) {
    a_part = a_parts[i]
    b_part = b_parts[i]

    is_numeric = a_part ~ /[0-9]+/

    if (is_numeric && (a_part + 0) > (b_part + 0)) {
      return -1
    }
    if (!is_numeric && a_part < b_part) {
      return -1
    }
    if (is_numeric && (a_part + 0) < (b_part + 0)) {
      return 1
    }
    if (!is_numeric && a_part > b_part) {
      return 1
    }
  }
  return 0
}

END {
  for (k in stats) {
    gsub(/LINES/, stats[k], k)
    rows[k] = k
  }

  asort(rows, sorted, \"compare_parts\")

  for (i in sorted) {
    print sorted[i]
  }
}" | column -t

